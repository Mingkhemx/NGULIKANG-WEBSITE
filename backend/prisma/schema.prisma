generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  user
  tukang
  admin
}

enum LamaranStatus {
  pending
  approved
  rejected
}

enum ServiceType {
  harian
  borongan
  renovasi
  premium
  korporate
  bangun
}

enum OrderStatus {
  pending
  in_progress
  completed
  cancelled
}

enum PaymentStatus {
  pending
  paid
  failed
}

enum GajiStatus {
  pending
  paid
}

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  password     String
  name         String
  phone        String?
  role         Role           @default(user)
  avatar       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  tukangProfile TukangProfile?
  lamaran       Lamaran[]
  orders        Order[]        @relation("UserOrders")
  assignedOrders Order[]       @relation("TukangOrders")
  transactions  Transaction[]
  gaji          Gaji[]         @relation("TukangGaji")
  chatRoomsUser ChatRoom[]     @relation("ChatUser")
  chatRoomsTukang ChatRoom[]   @relation("ChatTukang")
  messages      Message[]      @relation("UserMessages")
  progressUpdates OrderProgress[] @relation("OrderProgressUpdater")
  notifications Notification[]
  cartItems     Cart[]
  refreshTokens RefreshToken[]
}

model TukangProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  skills      String[] @default([])
  experience  String?
  rating      Float    @default(0)
  verified    Boolean  @default(false)
  bankAccount String?
  saldo       Decimal  @default(0) @db.Decimal(12, 2)
  priceHarian Decimal? @db.Decimal(12, 2)
  priceBorongan Decimal? @db.Decimal(12, 2)
  projectsCount Int      @default(0)
  reviewCount   Int      @default(0)
  isPopular     Boolean  @default(false)
  photoUrl      String?
  members       Json?
  reviewSamples Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Lamaran {
  id          String        @id @default(uuid())
  userId      String?
  email       String
  phone       String?
  fullName    String?
  ktp         String?
  address     String?
  maritalStatus String?
  domicile    String?
  relocate    Boolean?
  vehicle     String?
  experienceYears String?
  projectTypes String?
  jobRoles    String[]      @default([])
  skills      String[]      @default([])
  documents   String[]      @default([])
  cvUrl       String?
  status      LamaranStatus @default(pending)
  department  String?
  recruiter   String?
  note        String?
  submittedAt DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt

  user     User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  timeline LamaranTimeline[]
}

model LamaranTimeline {
  id        String   @id @default(uuid())
  lamaranId String
  title     String
  description String?
  status    String
  eventDate DateTime
  createdAt DateTime @default(now())

  lamaran Lamaran @relation(fields: [lamaranId], references: [id], onDelete: Cascade)

  @@index([lamaranId])
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Decimal  @db.Decimal(12, 2)
  category    String?
  location    String?
  imageUrl    String?
  condition   String?
  weight      Decimal? @db.Decimal(10, 2)
  weightUnit  String?
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cartItems     Cart[]
  productImages ProductImage[]
  productSpecs  ProductSpec[]
  reviews       ProductReview[]
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductSpec {
  id        String   @id @default(uuid())
  productId String
  label     String
  value     String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductReview {
  id         String   @id @default(uuid())
  productId  String
  authorName String
  rating     Int
  content    String
  mediaUrls  String[] @default([])
  createdAt  DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Order {
  id         String       @id @default(uuid())
  userId     String
  tukangId   String?
  serviceType ServiceType
  status     OrderStatus  @default(pending)
  totalPrice Decimal      @db.Decimal(12, 2)
  location   String?
  notes      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user   User  @relation("UserOrders", fields: [userId], references: [id], onDelete: Cascade)
  tukang User? @relation("TukangOrders", fields: [tukangId], references: [id], onDelete: SetNull)

  progressUpdates OrderProgress[]
  transactions    Transaction[]
  gaji            Gaji[]
}

model OrderProgress {
  id                 String   @id @default(uuid())
  orderId            String
  progressPercentage Int
  notes              String?
  images             String[] @default([])
  updatedBy          String
  updatedAt          DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  updater User @relation("OrderProgressUpdater", fields: [updatedBy], references: [id], onDelete: Cascade)
}

model Transaction {
  id            String        @id @default(uuid())
  orderId       String
  userId        String
  amount        Decimal       @db.Decimal(12, 2)
  paymentMethod String?
  paymentStatus PaymentStatus @default(pending)
  paidAt        DateTime?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Gaji {
  id       String    @id @default(uuid())
  tukangId String
  orderId  String?
  amount   Decimal   @db.Decimal(12, 2)
  status   GajiStatus @default(pending)
  paidAt   DateTime?

  tukang User  @relation("TukangGaji", fields: [tukangId], references: [id], onDelete: Cascade)
  order  Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)
}

model ChatRoom {
  id        String   @id @default(uuid())
  userId    String
  tukangId  String
  createdAt DateTime @default(now())

  user   User @relation("ChatUser", fields: [userId], references: [id], onDelete: Cascade)
  tukang User @relation("ChatTukang", fields: [tukangId], references: [id], onDelete: Cascade)
  messages Message[]
}

model Message {
  id       String   @id @default(uuid())
  roomId   String
  senderId String
  content  String
  read     Boolean  @default(false)
  sentAt   DateTime @default(now())

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Cart {
  id        String   @id @default(uuid())
  userId    String
  productId String
  quantity  Int      @default(1)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  revokedAt DateTime?
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
